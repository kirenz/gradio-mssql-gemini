---
title: "German Sales Analysis"
author: Mike Farmer
date: today
date-format: long
format:
  pptx:
    reference-doc: ../../assets/ppt/template.pptx
jupyter:
  kernelspec:
    name: gradio-mssql-gemini
    display_name: gradio-mssql-gemini
    language: python
---

```{python}
#| echo: false
import sys
from pathlib import Path

src_path = Path.cwd().resolve().parents[2] / "src"
if str(src_path) not in sys.path:
    sys.path.insert(0, str(src_path))

import os
import altair as alt
import pandas as pd
from IPython.display import Image, display

from quarto_mssql_gemini import get_sales_data
from quarto_mssql_gemini.ai import get_plot_description

output_dir = Path("outputs/plots")
output_dir.mkdir(parents=True, exist_ok=True)
```

```{python}
#| echo: false
# Pull the full dataset and filter for Germany
df = get_sales_data(country=["Germany"])
germany_sales = df.copy().sort_values("Calendar DueDate")
```

# Monthly Sales Analysis for Germany {.section}

## Sales Performance Overview {.section}

```{python}
#| echo: false
#| output: asis
summary = germany_sales.groupby("Calendar Month")[["Sales Amount", "Revenue EUR", "Gross Profit EUR"]].sum().reset_index()

monthly_chart = alt.Chart(summary).mark_line(point=True).encode(
    x=alt.X("Calendar Month:O", title="Month"),
    y=alt.Y("Revenue EUR:Q", title="Revenue (EUR)"),
    tooltip=["Calendar Month", "Revenue EUR"],
).properties(width=800, height=400, title="Monthly Revenue")

monthly_path = output_dir / "monthly_revenue.png"
monthly_chart.save(monthly_path)
display(Image(filename=str(monthly_path)))

monthly_metrics = {
    "Total Revenue": f"€{summary['Revenue EUR'].sum():,.0f}",
    "Average Monthly Revenue": f"€{summary['Revenue EUR'].mean():,.0f}",
    "Peak Month": f"{summary['Revenue EUR'].idxmax()} (€{summary['Revenue EUR'].max():,.0f})",
}

monthly_metrics_text = "\n".join(f"{k}: {v}" for k, v in monthly_metrics.items())

print(
    "\nAI Analysis:\n"
    + get_plot_description("Monthly sales performance trends in Germany", monthly_metrics_text)
)
```

## Regional Analysis {.section}

```{python}
#| echo: false
#| output: asis
region_summary = germany_sales.groupby("Sales Region").agg(
    {"Sales Amount": "sum", "Revenue EUR": "sum", "Gross Profit EUR": "sum"}
).round(2)

region_summary_styled = region_summary.style.format(
    {
        "Sales Amount": "{:,.0f}",
        "Revenue EUR": "€{:,.0f}",
        "Gross Profit EUR": "€{:,.0f}",
    }
)
display(region_summary_styled)

region_metrics = {
    "Total Revenue by Region": region_summary["Revenue EUR"].to_dict(),
    "Top Region": f"{region_summary['Revenue EUR'].idxmax()} (€{region_summary['Revenue EUR'].max():,.0f})",
    "Total Profit by Region": region_summary["Gross Profit EUR"].to_dict(),
}

region_metrics_text = "\n".join(f"{k}: {v}" for k, v in region_metrics.items())
region_analysis = get_plot_description(
    "Regional sales performance across German territories", region_metrics_text
)

region_chart = (
    alt.Chart(region_summary.reset_index())
    .mark_bar()
    .encode(
        x=alt.X("Sales Region:N", title="Region", axis=alt.Axis(labelAngle=0)),
        y=alt.Y("Revenue EUR:Q", title="Revenue (EUR)"),
        tooltip=["Sales Region", "Revenue EUR", "Gross Profit EUR"],
    )
    .properties(width=800, height=400, title="Revenue by Region")
)

region_path = output_dir / "region_revenue.png"
region_chart.save(region_path)
display(Image(filename=str(region_path)))

print("\nAI Analysis:\n" + region_analysis)
```

## Product Category Performance {.section}

```{python}
#| echo: false
#| output: asis
product_summary = (
    germany_sales.groupby("Product Category")
    .agg({"Sales Amount": "sum", "Revenue EUR": "sum", "Gross Profit EUR": "sum"})
    .sort_values("Revenue EUR", ascending=False)
)

product_metrics = {
    "Top Category": f"{product_summary.index[0]} (€{product_summary['Revenue EUR'].max():,.0f})",
    "Category Revenue Distribution": product_summary["Revenue EUR"].to_dict(),
    "Category Profit Margins": (product_summary["Gross Profit EUR"] / product_summary["Revenue EUR"]).to_dict(),
}

product_metrics_text = "\n".join(f"{k}: {v}" for k, v in product_metrics.items())
product_analysis = get_plot_description(
    "Product category performance analysis in Germany",
    product_metrics_text,
)

product_chart = (
    alt.Chart(product_summary.reset_index())
    .mark_bar()
    .encode(
        x=alt.X(
            "Product Category:N",
            title="Product Category",
            sort="-y",
            axis=alt.Axis(labelAngle=0),
        ),
        y=alt.Y("Revenue EUR:Q", title="Revenue (EUR)"),
        tooltip=["Product Category", "Revenue EUR", "Gross Profit EUR"],
    )
    .properties(width=800, height=400, title="Revenue by Product Category")
)

product_path = output_dir / "product_revenue.png"
product_chart.save(product_path)
display(Image(filename=str(product_path)))

print("\nAI Analysis:\n" + product_analysis)
```
